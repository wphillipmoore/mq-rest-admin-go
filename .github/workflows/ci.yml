name: CI - Test and Validate

on:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-only:
    name: "ci: docs-only"
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.detect.outputs.docs-only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Detect docs-only changes
        id: detect
        uses: wphillipmoore/standard-actions/actions/docs-only-detect@develop

  standards-compliance:
    name: "ci: standards-compliance"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate standards
        uses: wphillipmoore/standard-actions/actions/standards-compliance@develop

  dependency-audit:
    name: "ci: dependency-audit"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26"

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck (fail on any vulnerability)
        run: govulncheck ./...

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Run license compliance check
        run: >-
          go-licenses check ./...
          --allowed_licenses=Apache-2.0,BSD-2-Clause,BSD-3-Clause,MIT,ISC,MPL-2.0,GPL-3.0

  release-gates:
    name: "release: gates"
    runs-on: ubuntu-latest
    steps:
      - name: Skip on non-PR events
        if: github.event_name != 'pull_request'
        run: echo "Not a pull request; skipping release gates."

      - name: Checkout code
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Version divergence gate (PRs targeting develop)
        if: github.event_name == 'pull_request' && github.base_ref == 'develop'
        uses: wphillipmoore/standard-actions/actions/release-gates/version-divergence@develop
        with:
          head-version-command: grep -oP 'Version\s*=\s*"\K[^"]+' mqrestadmin/version.go
          main-version-command: git show origin/main:mqrestadmin/version.go | grep -oP 'Version\s*=\s*"\K[^"]+'

      - name: Tag validation placeholder (PRs targeting main)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: echo "Tag-based release validation not yet implemented for Go modules."

  test-and-validate:
    name: "test: unit"
    runs-on: ubuntu-latest
    needs: docs-only
    strategy:
      matrix:
        go-version: ["1.25", "1.26"]

    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping test-and-validate."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Set up Go
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Install gocyclo
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go install github.com/fzipp/gocyclo/cmd/gocyclo@latest

      - name: Run gocyclo (max complexity 15)
        if: needs.docs-only.outputs.docs-only != 'true'
        run: gocyclo -over 15 ./mqrestadmin/

      - name: Run go vet
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go vet ./...

      - name: Run golangci-lint
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: golangci/golangci-lint-action@v9

      - name: Run tests with coverage
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go test -race -count=1 -coverprofile=coverage.out ./...

      - name: Install go-test-coverage
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go install github.com/vladopajic/go-test-coverage/v2@latest

      - name: Enforce 100% coverage (excluding annotated lines)
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go-test-coverage --config .testcoverage.yml

  codeql:
    name: "security: codeql"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping CodeQL."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run CodeQL analysis
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/codeql@develop
        with:
          language: go

  trivy:
    name: "security: trivy"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping Trivy."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scan
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/trivy@develop
        with:
          scan-type: fs

  semgrep:
    name: "security: semgrep"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      security-events: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping Semgrep."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Run Semgrep SAST scan
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/security/semgrep@develop
        with:
          language: golang

  sonarcloud:
    name: "quality: sonarcloud"
    runs-on: ubuntu-latest
    needs: docs-only
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping SonarCloud."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/setup-go@v6
        with:
          go-version: "1.26"

      - name: Run tests with coverage
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go test -race -count=1 -coverprofile=coverage.out ./...

      - name: Run SonarCloud scan
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/quality/sonarcloud@develop
        with:
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          organization: wphillipmoore
          project-key: wphillipmoore_mq-rest-admin-go
          sources: "mqrestadmin"
          tests: "mqrestadmin"
          extra-args: >-
            -Dsonar.go.coverage.reportPaths=coverage.out
            -Dsonar.test.inclusions=**/*_test.go
            -Dsonar.exclusions=**/*_test.go

  codeclimate:
    name: "quality: codeclimate"
    runs-on: ubuntu-latest
    needs: docs-only
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping Code Climate."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Set up Go
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/setup-go@v6
        with:
          go-version: "1.26"

      - name: Run tests with coverage
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go test -race -count=1 -coverprofile=coverage.out ./...

      - name: Upload coverage to Qlty Cloud
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/standard-actions/actions/quality/codeclimate@develop
        with:
          files: "coverage.out"
          format: "coverprofile"

  integration-tests:
    name: "test: integration"
    runs-on: ubuntu-latest
    needs: docs-only
    strategy:
      matrix:
        include:
          - go-version: "1.25"
            project-suffix: "1-25"
            qm1-rest-port: "9443"
            qm2-rest-port: "9444"
          - go-version: "1.26"
            project-suffix: "1-26"
            qm1-rest-port: "9445"
            qm2-rest-port: "9446"

    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping integration tests."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v6

      - name: Set up Go
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}

      - name: Setup MQ environment
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: wphillipmoore/mq-rest-admin-dev-environment/.github/actions/setup-mq@main
        with:
          project-name: mq-rest-admin-go-${{ matrix.project-suffix }}
          qm1-rest-port: ${{ matrix.qm1-rest-port }}
          qm2-rest-port: ${{ matrix.qm2-rest-port }}

      - name: Run integration tests
        if: needs.docs-only.outputs.docs-only != 'true'
        env:
          MQ_REST_BASE_URL: https://localhost:${{ matrix.qm1-rest-port }}/ibmmq/rest/v2
          MQ_REST_BASE_URL_QM2: https://localhost:${{ matrix.qm2-rest-port }}/ibmmq/rest/v2
        run: |
          MQ_SKIP_LIFECYCLE=1 \
          MQ_REST_ADMIN_GO_RUN_INTEGRATION=1 \
          go test -race -count=1 -tags=integration ./...
