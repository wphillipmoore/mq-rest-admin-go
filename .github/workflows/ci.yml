name: CI - Test and Validate

on:
  pull_request:
  push:
    branches:
      - develop
      - 'release/**'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  docs-only:
    name: docs-only
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.detect.outputs.docs-only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect docs-only changes
        id: detect
        uses: wphillipmoore/standard-actions/actions/docs-only-detect@develop

  standards-compliance:
    name: standards-compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate standards
        uses: wphillipmoore/standard-actions/actions/standards-compliance@develop
        with:
          commit-cutoff-sha: "11d94c9"

  dependency-audit:
    name: dependency-audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck (fail on any vulnerability)
        run: govulncheck ./...

  release-gates:
    name: release-gates
    runs-on: ubuntu-latest
    steps:
      - name: Skip on non-PR events
        if: github.event_name != 'pull_request'
        run: echo "Not a pull request; skipping release gates."

      - name: Checkout code
        if: github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        if: github.event_name == 'pull_request'
        uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Version divergence gate (PRs targeting develop)
        if: github.event_name == 'pull_request' && github.base_ref == 'develop'
        run: |
          git fetch origin main --depth=1
          main_version=$(git show origin/main:go.mod | grep '^go ' | awk '{print $2}')
          head_version=$(grep '^go ' go.mod | awk '{print $2}')
          if [ "$main_version" = "$head_version" ]; then
            echo "FAIL: go.mod version ($head_version) must differ from main ($main_version)."
            exit 1
          fi
          echo "OK: go.mod version ($head_version) differs from main ($main_version)."

      - name: Tag validation placeholder (PRs targeting main)
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: echo "Tag-based release validation not yet implemented for Go modules."

  test-and-validate:
    name: test-and-validate
    runs-on: ubuntu-latest
    needs: docs-only
    strategy:
      matrix:
        go-version: ["1.25", "1.26"]

    steps:
      - name: Docs-only short-circuit
        if: needs.docs-only.outputs.docs-only == 'true'
        run: echo "Docs-only changes detected; skipping test-and-validate."

      - name: Checkout code
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/checkout@v4

      - name: Set up Go
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Run go vet
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go vet ./...

      - name: Run golangci-lint
        if: needs.docs-only.outputs.docs-only != 'true'
        uses: golangci/golangci-lint-action@v7

      - name: Run tests with coverage
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go test -race -count=1 -coverprofile=coverage.out ./...

      - name: Install go-ignore-cov
        if: needs.docs-only.outputs.docs-only != 'true'
        run: go install github.com/hexira/go-ignore-cov@v0.3.0

      - name: Enforce 100% coverage (excluding annotated lines)
        if: needs.docs-only.outputs.docs-only != 'true'
        run: |
          go-ignore-cov --file coverage.out
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | tr -d '%')
          echo "Coverage after exclusions: ${COVERAGE}%"
          if [ "$(echo "$COVERAGE < 100.0" | bc)" -eq 1 ]; then
            echo "FAIL: coverage is ${COVERAGE}%, required 100%"
            go tool cover -func=coverage.out | grep -v '100.0%'
            exit 1
          fi

  integration-test:
    name: integration-test
    runs-on: ubuntu-latest
    needs: docs-only
    if: needs.docs-only.outputs.docs-only != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26"

      - name: Setup MQ environment
        uses: wphillipmoore/mq-dev-environment/.github/actions/setup-mq@main
        with:
          project-name: mq-rest-admin-go

      - name: Run integration tests
        run: |
          MQ_SKIP_LIFECYCLE=1 \
          MQ_REST_ADMIN_GO_RUN_INTEGRATION=1 \
          go test -race -count=1 -tags=integration ./...
